<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KDSE Examination Form 2025-26</title>
<style>
body{margin:0;font-family:'Segoe UI',sans-serif;background:linear-gradient(135deg,#e8f5e9,#e3f2fd);}
.container{max-width:850px;margin:5px auto;background:white;padding:8px 12px;border-radius:8px;position:relative;overflow:hidden;}
.container::after{content:"KALYANI DEVI SCHOOL OF EDUCATION";position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) rotate(-30deg);font-size:42px;color:rgba(0,100,0,0.05);font-weight:bold;white-space:nowrap;pointer-events:none;}
.header{text-align:center;margin-bottom:6px;}
.school-name{font-size:24px;font-weight:900;color:#1b5e20;}
.address,.contact{font-size:14px;font-weight:700;color:#1b5e20;}
.udise{font-weight:900;color:#c62828;font-size:14px;}
.session{font-size:16px;font-weight:900;color:#0d47a1;}
.header-line{border-top:2px solid #000;margin:4px 0 6px;}
.form-group{margin-bottom:5px;}label{font-weight:700;font-size:11.5px;}
input,textarea,select{width:97%;padding:3px 4px;border:1px solid #555;border-radius:4px;font-size:11.5px;box-sizing:border-box;}
textarea{resize:none;}
.row{display:flex;gap:5px;}
.row .form-group{flex:1;}
.photo-box{width:90px;height:110px;float:right;margin-left:12px;border:1px solid #555;}
.photo-box img{width:100%;height:100%;object-fit:cover;}
.declaration-box{display:flex;align-items:center;gap:6px;font-size:11.5px;white-space:nowrap;margin-bottom:25px;}
.declaration-box input{width:auto;margin:0;cursor:pointer;}
.signature-section{display:flex;justify-content:space-between;margin-top:12px;font-size:11.5px;}
.signature{width:32%;text-align:center;font-weight:bold;}
.buttons{text-align:center;margin-top:6px;}
button{padding:4px 9px;border:none;border-radius:4px;margin:2px;font-size:11px;cursor:pointer;color:white;}
.print-btn{background:#2e7d32;display:none;}
.save-btn{background:#6a1b9a;}
.back-btn{background:#1565c0;}
.reset-btn{background:#9e9e9e;display:none;}
.form-id-box{display:none;margin-top:8px;}
@media(max-width:768px){.row{flex-direction:column;}}
@page{size:A4;margin:4mm;}
@media print{.buttons{display:none}.no-print{display:none !important}body{background:white}.container{padding:5px 8px}}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="school-name">KALYANI DEVI SCHOOL OF EDUCATION</div>
    <div class="address">Piparkhunta, Dewarhat, Lormi, Mungeli, Chhattisgarh – 495115</div>
    <div class="contact">Mobile: 8224821843 | Email: kdse1227@gmail.com</div>
    <div class="udise">UDISE Code - 22191213904</div>
    <div class="session">Examination Form 2025-26</div>
  </div>

  <div class="header-line"></div>

  <div class="photo-box"><img id="preview" alt=""></div>

  <form id="KDSE-2026-01">
    <div class="form-group form-id-box" id="formIdBox">
      <label>Form ID</label>
      <input type="text" id="formIdDisplay" readonly>
      <input type="hidden" id="formId">
    </div>

    <div class="row">
      <div class="form-group"><label>Student Name (English)</label><input type="text" id="studentEng"></div>
      <div class="form-group"><label>Student Name (Hindi)</label><input type="text" id="studentHin"></div>
    </div>

    <div class="row">
      <div class="form-group"><label>Father Name (English)</label><input type="text" id="fatherEng"></div>
      <div class="form-group"><label>Father Name (Hindi)</label><input type="text" id="fatherHin"></div>
    </div>

    <div class="row">
      <div class="form-group"><label>Mother Name (English)</label><input type="text" id="motherEng"></div>
      <div class="form-group"><label>Mother Name (Hindi)</label><input type="text" id="motherHin"></div>
    </div>

    <div class="row">
      <div class="form-group">
        <label>Class</label>
        <select id="classSelect">
          <option value="">Select</option>
          <option>9</option>
          <option>11</option>
        </select>
      </div>

      <div class="form-group">
        <label>DOB</label>
        <input type="date" id="dob">
      </div>
    </div>

    <div class="row">
      <div class="form-group">
        <label>Caste</label>
        <select id="caste">
          <option value="">Select</option>
          <option>General</option>
          <option>OBC</option>
          <option>SC</option>
          <option>ST</option>
        </select>
      </div>

      <div class="form-group">
        <label>Gender</label>
        <select id="gender">
          <option value="">Select</option>
          <option>Male</option>
          <option>Female</option>
          <option>Other</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div class="form-group">
        <label>Aadhar</label>
        <input type="text" id="aadhar" maxlength="12" inputmode="numeric" oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,12)">
      </div>

      <div class="form-group">
        <label>Mobile</label>
        <input type="text" id="mobile" maxlength="10" inputmode="numeric" oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,10)">
      </div>

      <div class="form-group">
        <label>Email</label>
        <input type="email" id="email">
      </div>
    </div>

    <div class="form-group">
      <label>Address</label>
      <textarea rows="2" id="address"></textarea>
    </div>

    <div class="form-group no-print">
      <label>Upload Photo</label>
      <input type="file" accept="image/*" onchange="previewImage(event)">
    </div>

    <div class="form-group declaration-box">
      <input type="checkbox" id="declaration" required>
      <span>मैं प्रमाणित करता/करती हूँ कि दी गयी जानकारी सत्य है।</span>
    </div>
  </form>

  <div class="signature-section">
    <div class="signature">_____________________<br>Student</div>
    <div class="signature">_____________________<br>Incharge</div>
    <div class="signature">_____________________<br>Principal</div>
  </div>

  <div class="buttons">
    <button class="print-btn" onclick="window.print()">Print</button>
    <button type="button" class="save-btn" onclick="saveRecord()">Save</button>
    <button class="back-btn" onclick="history.back()">Back</button>
    <button type="button" class="reset-btn" onclick="resetForm()">Reset Form</button>
  </div>
</div>

<script>
/* Replace with your deployed Apps Script web app URL (the /exec URL) */
const GAS_URL = "https://script.google.com/macros/s/AKfycbzLRaJ8a8eG1VQYs-HMreRQ2KW1HIwiwn8hJANzdtiBiwi62o_hfOt5XALe9B5CBYwM/exec";

function previewImage(event){
  const reader = new FileReader();
  reader.onload = function(){ document.getElementById('preview').src = reader.result; }
  if(event.target.files[0]) reader.readAsDataURL(event.target.files[0]);
}

function $(id){ return document.getElementById(id); }

function validateForm(){
  return $('studentEng').value && $('studentHin').value &&
    $('fatherEng').value && $('fatherHin').value &&
    $('motherEng').value && $('motherHin').value &&
    $('dob').value && $('gender').value &&
    $('caste').value && $('aadhar').value &&
    $('mobile').value && $('email').value &&
    $('address').value && $('classSelect').value &&
    $('declaration').checked;
}

function resetForm(){
  document.getElementById('KDSE-2026-01').reset();
  document.getElementById('preview').src = "";
  document.querySelector(".print-btn").style.display="none";
  document.querySelector(".reset-btn").style.display="none";
  document.getElementById('formIdBox').style.display = 'none';
  $('formId').value = '';
  $('formIdDisplay').value = '';
}

async function saveRecord(){
  if(!validateForm()){
    alert("Please fill all required fields");
    return;
  }
  if($('aadhar').value.length !== 12){ alert("Aadhar must be 12 digits"); return; }
  if($('mobile').value.length !== 10){ alert("Mobile must be 10 digits"); return; }

  let savedAadhars = JSON.parse(localStorage.getItem("savedAadhars") || "[]");
  if(savedAadhars.includes($('aadhar').value)){
    alert("इस Aadhar से पहले ही फॉर्म भरा जा चुका है!");
    return;
  }

  // build and submit hidden form to avoid CORS (Apps Script will postMessage back)
  const hf = document.createElement('form');
  hf.method = 'post';
  hf.action = GAS_URL;
  hf.style.display = 'none';

  const fields = {
    studentEng: $('studentEng').value,
    studentHin: $('studentHin').value,
    fatherEng: $('fatherEng').value,
    fatherHin: $('fatherHin').value,
    motherEng: $('motherEng').value,
    motherHin: $('motherHin').value,
    class: $('classSelect').value,
    dob: $('dob').value,
    caste: $('caste').value,
    gender: $('gender').value,
    aadhar: $('aadhar').value,
    mobile: $('mobile').value,
    email: $('email').value,
    address: $('address').value,
    timestamp: new Date().toISOString()
  };

  for(const k in fields){
    const inp = document.createElement('input');
    inp.type = 'hidden';
    inp.name = k;
    inp.value = fields[k] || '';
    hf.appendChild(inp);
  }

  document.body.appendChild(hf);

  const saveBtn = document.querySelector(".save-btn");
  const prevText = saveBtn.textContent;
  saveBtn.textContent = "Submitting...";
  saveBtn.disabled = true;

  // create iframe to receive response
  const iframe = document.createElement('iframe');
  iframe.name = 'resp_iframe';
  iframe.style.display = 'none';
  document.body.appendChild(iframe);
  hf.target = 'resp_iframe';

  // message listener to receive postMessage from Apps Script response
  function messageHandler(ev){
    try{
      const j = ev.data;
      if(!j || typeof j !== 'object') return;
      if(j.status === 'success'){
        savedAadhars.push($('aadhar').value);
        localStorage.setItem("savedAadhars", JSON.stringify(savedAadhars));
        $('formId').value = j.formId;
        $('formIdDisplay').value = j.formId;
        document.getElementById('formIdBox').style.display = 'block';
        alert("Form submitted and saved to sheet successfully!\nForm ID: " + j.formId);
        document.querySelector(".print-btn").style.display="inline-block";
        document.querySelector(".reset-btn").style.display="inline-block";
      } else {
        alert('Submission failed: ' + (j && j.message ? j.message : 'Unknown error'));
      }
    } catch(e){
      alert("Could not read response");
    } finally {
      window.removeEventListener('message', messageHandler);
      saveBtn.textContent = prevText;
      saveBtn.disabled = false;
      setTimeout(()=>{ iframe.remove(); hf.remove(); }, 1000);
    }
  }

  window.addEventListener('message', messageHandler, false);

  hf.submit();
}
</script>
</body>
</html>
